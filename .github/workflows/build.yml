name: Build and Release Domain Extractor

on:
  push:
    tags:
      - 'v*'  # Запуск при создании тега v1.0.0
  workflow_dispatch:  # Ручной запуск

jobs:
  build-windows-portable:
    runs-on: windows-latest
    permissions:
      contents: write  # Для создания релиза

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller chardet

    - name: Verify files
      run: |
        Get-ChildItem -Path .
        if (-not (Test-Path "icon.ico")) {
          Write-Error "icon.ico not found! Add it to the repository root."
          exit 1
        }
        if (-not (Test-Path "domain_extractor.py")) {
          Write-Error "domain_extractor.py not found!"
          exit 1
        }

    - name: Build with PyInstaller (with icon)
      run: |
        pyinstaller domain_extractor.spec
      continue-on-error: false

    - name: Verify build output
      run: |
        if (-not (Test-Path "dist/DomainExtractor/DomainExtractor.exe")) {
          Write-Error "Build failed: EXE not found!"
          exit 1
        }
        Write-Host "Build successful!"

    - name: Create portable package
      shell: pwsh
      run: |
        # Создаём папку portable
        New-Item -ItemType Directory -Force -Path portable | Out-Null

        # Копируем сборку
        Copy-Item -Path "dist/DomainExtractor" -Destination "portable/DomainExtractor" -Recurse -Force

        # README
        $readme = @"
# Domain Extractor - Portable Version

Программа для извлечения и обработки доменных имен из файлов.

## Инструкция
1. Запустите `DomainExtractor/DomainExtractor.exe`
2. Добавьте файлы (перетаскиванием или кнопкой)
3. Настройте формат, TLD, префиксы
4. Нажмите "Обработать всё"

Все библиотеки включены. Работает с флешки.
"@
        $readme | Out-File -FilePath "portable/README.txt" -Encoding UTF8

    - name: Create ZIP archive
      shell: pwsh
      run: |
        Compress-Archive -Path "portable/*" -DestinationPath "DomainExtractor-Windows-Portable.zip" -Force

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: DomainExtractor-Windows-Portable
        path: DomainExtractor-Windows-Portable.zip

    - name: Get version from tag
      id: get_version
      shell: bash
      run: |
        if [[ $GITHUB_REF == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        else
          VERSION="dev-$(date +'%Y%m%d-%H%M%S')"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        fi

    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v2
      with:
        name: Domain Extractor ${{ steps.get_version.outputs.VERSION }}
        tag_name: ${{ github.ref_name }}
        draft: false
        prerelease: false
        files: |
          DomainExtractor-Windows-Portable.zip
        body: |
          ## Domain Extractor ${{ steps.get_version.outputs.VERSION }}

          ### Скачать
          - **Windows Portable (x64)**: [DomainExtractor-Windows-Portable.zip](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/DomainExtractor-Windows-Portable.zip)

          ### Возможности
          - Извлечение доменов из множества файлов
          - Drag & Drop
          - Фильтр по TLD
          - Экспорт: TXT, CSV, JSON
          - Тёмная тема
          - Автоопределение кодировки
          - Предпросмотр

          ### Системные требования
          - Windows 10/11 (64-bit)
          - Не требует установки

          ---
          Собрано с помощью PyInstaller. Портативная версия.
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
